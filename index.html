<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Signal Scanner</title>
  <script src="https://cdn.jsdelivr.net/npm/technicalindicators@3.1.1/dist/browser.js"></script>
  <style>
    body { font-family: monospace; padding: 20px; background: #111; color: #eee; }
    .signal { font-size: 18px; white-space: pre-wrap; background: #222; padding: 10px; border-radius: 8px; }
    .long { color: #00ff99; }
    .short { color: #ff6666; }
  </style>
</head>
<body>
  <h2>Crypto Futures Signal Scanner (15m)</h2>
  <input id="symbolInput" placeholder="e.g. DFUSDT" value="DFUSDT" />
  <button onclick="scan()">Scan</button>
  <div id="output" class="signal"></div>

  <script>
    const { EMA, RSI, MACD } = technicalindicators;

    async function fetchData(symbol) {
      const res = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=150`);
      const data = await res.json();
      return data;
    }

    function generateSignal(data) {
      const closes = data.map(c => parseFloat(c[4]));
      const highs = data.map(c => parseFloat(c[2]));
      const lows = data.map(c => parseFloat(c[3]));
      const volumes = data.map(c => parseFloat(c[5]));

      const ema7 = EMA.calculate({ period: 7, values: closes });
      const ema25 = EMA.calculate({ period: 25, values: closes });
      const ema99 = EMA.calculate({ period: 99, values: closes });
      const rsi = RSI.calculate({ period: 6, values: closes });
      const macd = MACD.calculate({
        values: closes,
        fastPeriod: 12,
        slowPeriod: 26,
        signalPeriod: 9,
        SimpleMAOscillator: false,
        SimpleMASignal: false
      });

      const lastIndex = macd.length - 1;
      if (lastIndex < 1 || closes.length < 99) return null;

      const lastClose = closes[closes.length - 1];
      const lastRSI = rsi[rsi.length - 1];
      const prevHist = macd[lastIndex - 1].histogram;
      const lastHist = macd[lastIndex].histogram;

      const macdRising = lastHist > prevHist;
      const macdCrossUp = prevHist < 0 && lastHist > 0 && macdRising;
      const macdCrossDown = prevHist > 0 && lastHist < 0 && lastHist < prevHist;

      const avgVolume = volumes.slice(-10).reduce((a, b) => a + b, 0) / 10;
      const lastVolume = volumes[volumes.length - 1];
      const volumeCondition = lastVolume > avgVolume;

      const candleRanges = highs.map((h, i) => h - lows[i]);
      const avgRange = candleRanges.slice(-10).reduce((a, b) => a + b, 0) / 10;
      const lastRange = candleRanges[candleRanges.length - 1];
      const volatilityCondition = lastRange < avgRange * 2.5;

      const open = parseFloat(data[data.length - 1][1]);
      const isDoji = Math.abs(open - lastClose) / (highs[highs.length - 1] - lows[lows.length - 1]) < 0.1;

      const nearEMA25 = Math.abs(lastClose - ema25[ema25.length - 1]) / lastClose < 0.005;
      const nearEMA99 = Math.abs(lastClose - ema99[ema99.length - 1]) / lastClose < 0.01;

      const buy =
        macdCrossUp &&
        lastRSI > 55 && lastRSI < 70 &&
        (nearEMA25 || nearEMA99) &&
        volumeCondition &&
        volatilityCondition &&
        !isDoji;

      const sell =
        macdCrossDown &&
        lastRSI < 45 &&
        (nearEMA25 || nearEMA99) &&
        volumeCondition &&
        volatilityCondition &&
        !isDoji;

      if (buy || sell) {
        const signal = buy ? "LONG" : "SHORT";
        const entry = lastClose;
        const tp = buy ? entry * 1.03 : entry * 0.97;
        const sl = buy ? entry * 0.98 : entry * 1.02;

        return {
          signal,
          entry: entry.toFixed(6),
          takeProfit: tp.toFixed(6),
          stopLoss: sl.toFixed(6),
          confidence: "HIGH"
        };
      }

      return null;
    }

    async function scan() {
      const symbol = document.getElementById("symbolInput").value.toUpperCase();
      const output = document.getElementById("output");
      output.innerText = "Analyzing...";

      try {
        const data = await fetchData(symbol);
        const signal = generateSignal(data);

        if (signal) {
          output.innerHTML = `ü™ô Symbol: ${symbol}\n` +
            `üìà Signal: <span class="${signal.signal === 'LONG' ? 'long' : 'short'}">${signal.signal}</span>\n` +
            `üéØ Entry: ${signal.entry}\n` +
            `‚úÖ Take Profit: ${signal.takeProfit}\n` +
            `‚ùå Stop Loss: ${signal.stopLoss}\n` +
            `‚ö° Confidence: ${signal.confidence}`;
        } else {
          output.innerHTML = `No strong signal found for ${symbol}.`;
        }
      } catch (err) {
        output.innerText = "Error fetching data or generating signal.";
        console.error(err);
      }
    }
  </script>
</body>
</html>
